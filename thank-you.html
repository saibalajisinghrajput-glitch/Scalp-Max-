<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thank You - Scalp Max</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Scalp Max</h1>
            <p>Thank You for Your Order!</p>
        </header>

        <main>
            <div class="thank-you-card">
                <div class="success-icon">✓</div>
                <h2>Order Placed Successfully!</h2>
                <p class="order-id">Order ID: <span id="orderId">Loading...</span></p>
                
                <div class="order-status">
                    <div class="status-badge pending" id="statusBadge">Payment Pending</div>
                </div>
                
                <div class="instructions">
                    <h3>Next Steps:</h3>
                    <div id="paymentInstructions">
                        <p>Please complete your payment via UPI.</p>
                        <p>UPI ID: <strong>scalpmax@upi</strong></p>
                        <p>Amount: <strong>₹1,499</strong></p>
                    </div>
                    <div id="codInstructions" style="display:none;">
                        <p>You chose Cash on Delivery.</p>
                        <p>You will receive your package soon!</p>
                    </div>
                </div>

                <button id="confirmPayment" class="btn-primary btn-full">I Have Completed Payment</button>
                
                <div id="confirmationMessage" class="confirmation-message" style="display:none;">
                    <div class="success-animation">✓</div>
                    <h3>Payment Confirmed!</h3>
                    <p>Your order is now being processed.</p>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 Scalp Max. All rights reserved.</p>
        </footer>
    </div>

    <script src="config.js"></script>
    <script>
        let currentOrderId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            currentOrderId = localStorage.getItem('lastOrderId');
            const paymentMethod = localStorage.getItem('paymentMethod');
            
            if (!currentOrderId) {
                document.getElementById('orderId').textContent = 'Not found';
                return;
            }

            document.getElementById('orderId').textContent = currentOrderId;

            if (paymentMethod === 'COD') {
                document.getElementById('paymentInstructions').style.display = 'none';
                document.getElementById('codInstructions').style.display = 'block';
                document.getElementById('confirmPayment').textContent = 'Order Confirmed';
                document.getElementById('confirmPayment').disabled = true;
                document.getElementById('statusBadge').textContent = 'Processing';
            }

            try {
                const { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .eq('order_id', currentOrderId)
                    .single();

                if (error) {
                    console.error('Error fetching order:', error);
                } else if (orders) {
                    updateUI(orders);
                }
            } catch (err) {
                console.error('Error fetching order:', err);
            }
        });

        document.getElementById('confirmPayment').addEventListener('click', async () => {
            if (!currentOrderId) return;

            try {
                const { data, error } = await supabaseClient
                    .from('orders')
                    .update({ 
                        status: 'confirmed',
                        payment: 'Paid'
                    })
                    .eq('order_id', currentOrderId)
                    .select();

                if (error) {
                    console.error('Error updating order:', error);
                    alert('Error confirming payment. Please try again.');
                    return;
                }

                document.getElementById('confirmPayment').style.display = 'none';
                document.getElementById('confirmationMessage').style.display = 'block';
                document.getElementById('statusBadge').textContent = 'Payment Confirmed';
                document.getElementById('statusBadge').className = 'status-badge confirmed';
                
                localStorage.removeItem('lastOrderId');
                localStorage.removeItem('paymentMethod');
            } catch (err) {
                console.error('Error confirming payment:', err);
                alert('Error confirming payment. Please try again.');
            }
        });

        function updateUI(order) {
            if (order.status === 'confirmed') {
                document.getElementById('confirmPayment').style.display = 'none';
                document.getElementById('confirmationMessage').style.display = 'block';
                document.getElementById('statusBadge').textContent = 'Payment Confirmed';
                document.getElementById('statusBadge').className = 'status-badge confirmed';
            } else if (order.status === 'pending') {
                document.getElementById('statusBadge').textContent = 'Payment Pending';
            }
        }
    </script>
</body>
</html>

